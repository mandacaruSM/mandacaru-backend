# ===============================================
# ARQUIVO: mandacaru_bot/bot_reports/handlers.py
# Handlers para relat√≥rios e hist√≥rico
# ===============================================

import logging
from datetime import datetime, date, timedelta
from typing import Dict, Any, Optional, List
from aiogram import Dispatcher, F
from aiogram.types import (
    Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
)

from core.session import obter_operador_sessao, verificar_autenticacao
from core.db import fazer_requisicao_api
from core.templates import MessageTemplates
from core.utils import Formatters

logger = logging.getLogger(__name__)

# ===============================================
# FUN√á√ïES DE RELAT√ìRIO
# ===============================================

async def buscar_historico_checklist(checklist_id: int) -> Optional[Dict[str, Any]]:
    """Busca hist√≥rico detalhado de um checklist"""
    logger.info(f"üìä Buscando hist√≥rico do checklist {checklist_id}")
    
    # Buscar dados do checklist
    checklist = await fazer_requisicao_api('GET', f'nr12/checklists/{checklist_id}/')
    
    if not checklist:
        return None
    
    # Buscar itens do checklist
    itens = await fazer_requisicao_api('GET', f'nr12/checklists/{checklist_id}/itens/')
    
    if itens:
        checklist['itens'] = itens.get('results', []) if isinstance(itens, dict) else itens
    else:
        checklist['itens'] = []
    
    return checklist

async def buscar_checklists_equipamento_periodo(
    equipamento_id: int, 
    dias: int = 30
) -> List[Dict[str, Any]]:
    """Busca checklists de um equipamento nos √∫ltimos X dias"""
    logger.info(f"üìä Buscando checklists do equipamento {equipamento_id} - √∫ltimos {dias} dias")
    
    result = await fazer_requisicao_api('GET', f'equipamentos/{equipamento_id}/checklists/', 
                                       params={'dias': dias})
    
    if result and result.get('checklists'):
        checklists = result['checklists']
        logger.info(f"‚úÖ {len(checklists)} checklists encontrados")
        return checklists
    
    logger.warning(f"‚ö†Ô∏è Nenhum checklist encontrado para equipamento {equipamento_id}")
    return []

# ===============================================
# HANDLERS DE RELAT√ìRIO
# ===============================================

def require_auth(handler):
    """Decorator que exige autentica√ß√£o (reutilizado)"""
    async def wrapper(obj, *args, **kwargs):
        if hasattr(obj, 'chat'):
            chat_id = str(obj.chat.id)
        elif hasattr(obj, 'message') and hasattr(obj.message, 'chat'):
            chat_id = str(obj.message.chat.id)
        else:
            logger.error("‚ùå N√£o foi poss√≠vel determinar chat_id")
            return
        
        if not verificar_autenticacao(chat_id):
            await obj.answer(MessageTemplates.unauthorized_access())
            return
        
        operador = obter_operador_sessao(chat_id)
        kwargs['operador'] = operador
        
        return await handler(obj, *args, **kwargs)
    
    return wrapper

@require_auth
async def mostrar_relatorio_checklist(callback: CallbackQuery, operador=None):
    """Mostra relat√≥rio detalhado de um checklist"""
    
    try:
        await callback.answer("üìä Carregando relat√≥rio...")
        
        # Extrair ID do checklist
        checklist_id = int(callback.data.split('_')[-1])
        
        # Buscar dados completos
        historico = await buscar_historico_checklist(checklist_id)
        
        if not historico:
            await callback.message.edit_text(
                "‚ùå **Checklist N√£o Encontrado**\n\n"
                "N√£o foi poss√≠vel carregar os dados do checklist.",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="üîô Voltar", callback_data="list_checklists")]
                ])
            )
            return
        
        # Montar relat√≥rio
        equipamento_nome = historico.get('equipamento_nome', 'Equipamento')
        data_checklist = historico.get('data_checklist', 'N/A')
        turno = historico.get('turno', 'N/A')
        status = historico.get('status', 'N/A')
        responsavel = historico.get('responsavel_nome', 'N/A')
        
        # Estat√≠sticas dos itens
        itens = historico.get('itens', [])
        total_itens = len(itens)
        itens_ok = len([i for i in itens if i.get('status') == 'OK'])
        itens_nok = len([i for i in itens if i.get('status') == 'NOK'])
        itens_na = len([i for i in itens if i.get('status') == 'NA'])
        itens_pendentes = len([i for i in itens if i.get('status') == 'PENDENTE'])
        
        # Criar texto do relat√≥rio
        texto = f"üìä **Relat√≥rio do Checklist**\n\n"
        texto += f"üöú **Equipamento:** {equipamento_nome}\n"
        texto += f"üìÖ **Data:** {data_checklist}\n"
        texto += f"üïê **Turno:** {turno}\n"
        texto += f"üë§ **Respons√°vel:** {responsavel}\n"
        texto += f"üìä **Status:** {status}\n\n"
        
        texto += f"üìã **Estat√≠sticas:**\n"
        texto += f"‚úÖ **Aprovados:** {itens_ok}/{total_itens}\n"
        texto += f"‚ùå **Reprovados:** {itens_nok}/{total_itens}\n"
        texto += f"‚ûñ **N/A:** {itens_na}/{total_itens}\n"
        
        if itens_pendentes > 0:
            texto += f"‚è≥ **Pendentes:** {itens_pendentes}/{total_itens}\n"
        
        # Calcular percentual de aprova√ß√£o
        if total_itens > 0:
            percentual = (itens_ok / total_itens) * 100
            texto += f"\nüìà **Taxa de Aprova√ß√£o:** {percentual:.1f}%"
        
        # Mostrar itens reprovados se houver
        if itens_nok > 0:
            texto += f"\n\n‚ùå **Itens Reprovados:**"
            itens_reprovados = [i for i in itens if i.get('status') == 'NOK']
            for i, item in enumerate(itens_reprovados[:5], 1):  # Mostrar at√© 5
                nome_item = item.get('item', 'Item')[:30] + "..." if len(item.get('item', '')) > 30 else item.get('item', 'Item')
                texto += f"\n{i}. {nome_item}"
                if item.get('observacao'):
                    obs = item['observacao'][:40] + "..." if len(item['observacao']) > 40 else item['observacao']
                    texto += f"\n   üí¨ {obs}"
            
            if len(itens_reprovados) > 5:
                texto += f"\n... e mais {len(itens_reprovados) - 5} item(s)"
        
        # Criar keyboard
        keyboard = []
        
        # Bot√µes de a√ß√£o
        keyboard.append([
            InlineKeyboardButton(text="üìã Detalhes Completos", callback_data=f"report_details_{checklist_id}"),
            InlineKeyboardButton(text="üì§ Exportar", callback_data=f"report_export_{checklist_id}")
        ])
        
        # Navega√ß√£o
        keyboard.append([
            InlineKeyboardButton(text="üîô Voltar", callback_data="list_checklists"),
            InlineKeyboardButton(text="üè† Menu", callback_data="menu_refresh")
        ])
        
        await callback.message.edit_text(
            texto,
            reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard)
        )
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao mostrar relat√≥rio: {e}")
        await callback.message.edit_text(MessageTemplates.error_generic())

@require_auth
async def mostrar_historico_equipamento(callback: CallbackQuery, operador=None):
    """Mostra hist√≥rico de checklists de um equipamento"""
    
    try:
        await callback.answer("üìä Carregando hist√≥rico...")
        
        # Extrair ID do equipamento
        equipamento_id = int(callback.data.split('_')[-1])
        
        # Buscar checklists dos √∫ltimos 30 dias
        checklists = await buscar_checklists_equipamento_periodo(equipamento_id, 30)
        
        if not checklists:
            await callback.message.edit_text(
                "üìä **Hist√≥rico Vazio**\n\n"
                "N√£o h√° checklists registrados para este equipamento nos √∫ltimos 30 dias.",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="üìã Criar Checklist", callback_data=f"create_checklist_{equipamento_id}")],
                    [InlineKeyboardButton(text="üîô Voltar", callback_data=f"equipment_select_{equipamento_id}")]
                ])
            )
            return
        
        # Ordenar por data (mais recente primeiro)
        checklists_ordenados = sorted(
            checklists, 
            key=lambda x: x.get('data_checklist', ''), 
            reverse=True
        )
        
        # Criar texto do hist√≥rico
        texto = f"üìä **Hist√≥rico de Checklists**\n\n"
        texto += f"üìÖ **Per√≠odo:** √öltimos 30 dias\n"
        texto += f"üìã **Total:** {len(checklists)} checklist(s)\n\n"
        
        # Mostrar at√© 10 checklists mais recentes
        keyboard = []
        
        for i, checklist in enumerate(checklists_ordenados[:10], 1):
            data = checklist.get('data_checklist', 'N/A')
            status = checklist.get('status', 'N/A')
            turno = checklist.get('turno', 'N/A')
            
            # Emoji baseado no status
            emoji = "‚úÖ" if status == "CONCLUIDO" else "üîÑ" if status == "EM_ANDAMENTO" else "üìã"
            
            texto += f"{i}. {emoji} **{data}** - {turno}\n"
            texto += f"   Status: {status}\n\n"
            
            # Bot√£o para ver detalhes
            callback_data = f"report_checklist_{checklist.get('id', 0)}"
            keyboard.append([
                InlineKeyboardButton(
                    text=f"{emoji} {data} - {turno}",
                    callback_data=callback_data
                )
            ])
        
        if len(checklists_ordenados) > 10:
            texto += f"... e mais {len(checklists_ordenados) - 10} checklist(s)"
        
        # Bot√µes de navega√ß√£o
        keyboard.append([
            InlineKeyboardButton(text="üìà Estat√≠sticas", callback_data=f"stats_equipment_{equipamento_id}"),
            InlineKeyboardButton(text="üìã Novo Checklist", callback_data=f"create_checklist_{equipamento_id}")
        ])
        
        keyboard.append([
            InlineKeyboardButton(text="üîô Voltar", callback_data=f"equipment_select_{equipamento_id}")
        ])
        
        await callback.message.edit_text(
            texto,
            reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard)
        )
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao mostrar hist√≥rico: {e}")
        await callback.message.edit_text(MessageTemplates.error_generic())

@require_auth
async def mostrar_estatisticas_equipamento(callback: CallbackQuery, operador=None):
    """Mostra estat√≠sticas de um equipamento"""
    
    try:
        await callback.answer("üìà Calculando estat√≠sticas...")
        
        # Extrair ID do equipamento
        equipamento_id = int(callback.data.split('_')[-1])
        
        # Buscar checklists de per√≠odos diferentes
        checklists_30d = await buscar_checklists_equipamento_periodo(equipamento_id, 30)
        checklists_7d = await buscar_checklists_equipamento_periodo(equipamento_id, 7)
        
        # Calcular estat√≠sticas
        total_30d = len(checklists_30d)
        total_7d = len(checklists_7d)
        
        if total_30d == 0:
            await callback.message.edit_text(
                "üìà **Estat√≠sticas**\n\n"
                "N√£o h√° dados suficientes para gerar estat√≠sticas.",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="üîô Voltar", callback_data=f"qr_list_checklists_{equipamento_id}")]
                ])
            )
            return
        
        # Analisar status dos checklists
        concluidos_30d = len([c for c in checklists_30d if c.get('status') == 'CONCLUIDO'])
        concluidos_7d = len([c for c in checklists_7d if c.get('status') == 'CONCLUIDO'])
        
        # Taxa de conclus√£o
        taxa_30d = (concluidos_30d / total_30d * 100) if total_30d > 0 else 0
        taxa_7d = (concluidos_7d / total_7d * 100) if total_7d > 0 else 0
        
        # Frequ√™ncia (checklists por semana)
        freq_semanal = total_30d / 4.3  # 30 dias ‚âà 4.3 semanas
        
        # Criar texto das estat√≠sticas
        texto = f"üìà **Estat√≠sticas do Equipamento**\n\n"
        
        texto += f"üìä **√öltimos 30 dias:**\n"
        texto += f"‚Ä¢ Total de checklists: {total_30d}\n"
        texto += f"‚Ä¢ Conclu√≠dos: {concluidos_30d}\n"
        texto += f"‚Ä¢ Taxa de conclus√£o: {taxa_30d:.1f}%\n\n"
        
        texto += f"üìä **√öltimos 7 dias:**\n"
        texto += f"‚Ä¢ Total de checklists: {total_7d}\n"
        texto += f"‚Ä¢ Conclu√≠dos: {concluidos_7d}\n"
        texto += f"‚Ä¢ Taxa de conclus√£o: {taxa_7d:.1f}%\n\n"
        
        texto += f"‚ö° **Frequ√™ncia:**\n"
        texto += f"‚Ä¢ M√©dia: {freq_semanal:.1f} checklists/semana\n\n"
        
        # Tend√™ncia
        if taxa_7d > taxa_30d:
            texto += f"üìà **Tend√™ncia:** Melhorando (+{taxa_7d - taxa_30d:.1f}%)"
        elif taxa_7d < taxa_30d:
            texto += f"üìâ **Tend√™ncia:** Declinando ({taxa_7d - taxa_30d:.1f}%)"
        else:
            texto += f"üìä **Tend√™ncia:** Est√°vel"
        
        keyboard = [
            [
                InlineKeyboardButton(text="üìã Ver Hist√≥rico", callback_data=f"qr_list_checklists_{equipamento_id}"),
                InlineKeyboardButton(text="üìã Novo Checklist", callback_data=f"create_checklist_{equipamento_id}")
            ],
            [InlineKeyboardButton(text="üîô Voltar", callback_data=f"equipment_select_{equipamento_id}")]
        ]
        
        await callback.message.edit_text(
            texto,
            reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard)
        )
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao mostrar estat√≠sticas: {e}")
        await callback.message.edit_text(MessageTemplates.error_generic())

# ===============================================
# REGISTRAR HANDLERS
# ===============================================

def register_handlers(dp: Dispatcher):
    """Registra handlers de relat√≥rios no dispatcher"""
    
    # Callbacks de relat√≥rio
    dp.callback_query.register(mostrar_relatorio_checklist, F.data.startswith("report_checklist_"))
    dp.callback_query.register(mostrar_relatorio_checklist, F.data.startswith("checklist_report_"))
    dp.callback_query.register(mostrar_historico_equipamento, F.data.startswith("qr_list_checklists_"))
    dp.callback_query.register(mostrar_historico_equipamento, F.data.startswith("checklist_history_"))
    dp.callback_query.register(mostrar_estatisticas_equipamento, F.data.startswith("stats_equipment_"))
    dp.callback_query.register(mostrar_estatisticas_equipamento, F.data.startswith("qr_report_"))
    
    logger.info("‚úÖ Handlers de relat√≥rios registrados")